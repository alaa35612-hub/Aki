# تصميم «حبيبي ٢»

## نظرة عامة
«حبيبي ٢» ترجمة حرفيّة (سلوكيًا) لمؤشر TradingView Smart Money Algo Pro E5. الهدف هو استنساخ المنطق بدقّة 100٪ مع تمثيل رقمي بديل للرسومات، وتشغيل نفس المعالجة على بيانات Binance Futures USDT-M.

## خطوات خط الأنابيب

### 1. قراءة البيانات
- **مصدر البيانات**: إطار بيانات `pandas` يحتوي على أعمدة OHLCV.
- **التسلسل الزمني**: يجري التأكد من ترتيب الأعمدة وتحويل الأنواع إلى `float` وإسقاط القيم الفارغة.
- **الماسح**: عند التشغيل عبر Binance يتم استدعاء `BinanceFetcher.fetch_ohlcv` لإرجاع OHLCV لرمز واحد، مع خيار تجاهل آخر شمعة لمضاهاة Pine على الشموع المؤكدة.

### 2. التحليل
- **المؤشر**: `SMCIndicator` يحاكي منطق Pine بالكامل داخل دورة لكل شمعة.
- **دفتر الأستاذ الرقمي**: `DigitalBookkeeping` يحتفظ بنسخ رقمية لكل ما ترسمه نسخة Pine (labels/lines) ويطبق نفس إجراءات الحذف (`fixStrcAfterBos/Choch`) عبر وضع `None` على المواقع المناسبة بدل الحذف، مما يضمن التطابق العددي عند استرجاع القيم الأخيرة.
- **بناء الهياكل**: يتم تحديث القمم/القيعان، التعامل مع Mother/Inside Bar الصارمة، إنشاء مناطق الطلب/العرض من الشمعة `b-2`، دمج المناطق المتداخلة، وتحديد مناطق EXT/IDM بنفس قواعد Pine.
- **الهياكل المتقدمة**: عند حصول BOS/CHoCh يتم ضبط اتجاه الهيكل وتمهيد البحث عن IDM. تتولى `_idm_take_unlock` المنطق الكامل لأخذ IDM، بما في ذلك استدعاء إصلاح الهياكل واسترجاع المراسي كما في Pine عند تفعيل خيار "Choch with IDM".

### 3. إنتاج الإشارات
- يتم تجميع نتائج كل شمعة في `signals_df` الذي يحتوي على أعلام BOS/CHoCh ولمسات IDM، متطابقة مع ما يضعه Pine على الرسم.
- `levels_df` يكرر أحدث قيم `lastH/lastL/H/L/IDM/Mother`، بينما `zones_df` تعكس كل منطقة مكتشفة بحالاتها (FRESH/ACTIVATED/MITIGATED).
- الحفاظ على هذه الهياكل بدقة يسمح بمضاهاة السلوك تمامًا، بما في ذلك إعادة تعيين المراسي بعد إصلاح الهياكل.

### 4. الرسم والتأشير (تمثيل رقمي)
- بدلاً من الرسم على الشاشة يتم تسجيل الأحداث في `DigitalBookkeeping` والاحتفاظ بالمؤشرات كقوائم من القيم/المعرفات الرقمية.
- عمليات الحذف في Pine (`removeLastLabel`, `removeNLastLabel`, ...) تُترجم إلى وضع `None` على نفس المواقع حتى تبقى الأطوال كما في Pine، ما يضمن أن أي قراءة لاحقة (`getNLastValue`) تعيد نفس القيمة المتوقعة.

### 5. التنبيهات
- يتم دفع التنبيهات إلى `alerts_df` وترسل عبر وحدة `TelegramNotifier` اختياريًا.
- ماسح Binance (`FuturesScanner`) يعيد تشغيل المؤشر لكل رمز ويطبع/يرسل التنبيهات لأحدث الشموع بناءً على إعداد `recent_bars`.
- يمكن ضبط نوع الهيكل (`--structure-type`) وطريقة الـMitigation (`--mitigation`) لضبط المنطق تمامًا كما في واجهة Pine الأصلية.

## اختبارات التوافق
- وحدات الاختبار (`tests/test_structure_alignment.py`) تولّد سيناريوهات مصطنعة تتحقق من أن إصلاح الهياكل وإعادة تعيين المراسي يحدثان كما في Pine عند أخذ IDM سواءً كان الحدث بعد BOS أو CHoCh، ما يضمن أن المنطق البيني مطابق بالكامل.
